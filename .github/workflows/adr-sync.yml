# GitHub Actions workflow for git-adr sync
# Generated by: git adr ci github --sync
#
# This workflow syncs ADR notes to the repository wiki on push to main.
# Notes are fetched from the remote and can optionally be exported to the wiki.

name: Sync ADRs

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual triggers

permissions:
  contents: read

jobs:
  sync-adrs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for notes

      - name: Fetch git notes
        run: |
          # Configure notes refs for fetching
          git config --add remote.origin.fetch '+refs/notes/*:refs/notes/*'
          git fetch origin 'refs/notes/*:refs/notes/*'

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install git-adr
        run: pip install git-adr==0.2.1

      - name: Initialize git-adr
        run: |
          # Force init to configure local state even when notes exist from fetch
          # This is required due to git-adr bug: "list" fails without init,
          # but "init" without --force fails when notes namespace exists
          git adr init --no-input --force

      - name: Validate ADRs
        run: |
          # Check ADR structure and metadata
          git adr list --format json > /dev/null 2>&1 || echo "No ADRs found (this is OK)"
          echo "ADR validation passed"

      - name: Summary
        run: |
          echo "## ADR Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          TOTAL=$(git adr list --format json 2>/dev/null | jq '. | length' 2>/dev/null || echo 0)
          PROPOSED=$(git adr list --status proposed --format json 2>/dev/null | jq '. | length' 2>/dev/null || echo 0)
          ACCEPTED=$(git adr list --status accepted --format json 2>/dev/null | jq '. | length' 2>/dev/null || echo 0)
          echo "| Total ADRs | $TOTAL |" >> $GITHUB_STEP_SUMMARY
          echo "| Proposed | $PROPOSED |" >> $GITHUB_STEP_SUMMARY
          echo "| Accepted | $ACCEPTED |" >> $GITHUB_STEP_SUMMARY
